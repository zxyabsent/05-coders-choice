defmodule HumanPlayer.Impl do
  @server_name Noughts.Controller
  @name :player

  def new_game(node) do
    Process.register(self(), @name)
    node
    |> Node.connect
    |> checkConnect(node)
  end

  def checkConnect(:true, node) do
    send { @server_name, node}, {self(), @name, node(), :new_game }
    state = receive do
      { :game_start, chessboard, :true}  -> {chessboard, :true}
      { :game_start, chessboard, :false} -> {chessboard, :false}
    end
    get_next_move(state, node)
  end

  def checkConnect(:true, node) do
    IO.puts "Connection failed!"
  end

  def message_loop() do
    receive do
      message -> get_next_move(message)
    end

    message_loop()
  end  

  def get_next_move({:won}) do
    IO.puts "\nCONGRATULATIONS! You won this game! Well played :-)"
  end

  def get_next_move({:tie}) do
    IO.puts "\nJesus! It was a tie! Have a new try!"
  end

  def get_next_move({:lucky_won}) do
    IO.puts "\nCONGRATULATIONS! You won this game because your opponent left the game!"
  end

  def get_next_move({chessboard, :false}) do
    HumanPlayer.Agent.start_link("o") # o first x later
    draw_current_board(chessboard)
    IO.puts "Your opponent moves fisrt! Waiting for his move!"
  end

  def get_next_move({chessboard, :true}) do
    HumanPlayer.Agent.start_link("x")
    draw_current_board(chessboard)
    IO.puts "You move first! Think about a nice beginning!"
    cb = List.update_at(chessboard, get_move - 1, &(&1 = "x")) |> drawing()
    send {@server_name, node}, {@name, node(), cb, :make_move}
  end

  def get_next_move({:received}) do
    IO.puts "Nice move! Now it is your opponent's turn!"
  end

  def get_next_move({:your_turn, chessboard}) do
    chess =  HumanPlayer.Agent.get_chess
    draw_current_board(chessboard)
    IO.puts "It is your turn! Move on!"
    cb = List.update_at(chessboard, get_move - 1, &(&1 = chess)) |> drawing()
    send {@server_name, node}, {@name, node(), cb, :make_move}
  end

  def draw_current_board(cb) do
    IO.write "\e[H\e[2J"
    IO.puts drawing(cb)
  end

  def get_move() do
    [a, b] =
      IO.gets ("Your move:   ")
      |> String.trim
      |> String.slice(1..3)
      |> String.split(",")
    x = Integer.parse(a) # xth line
    y = Integer.parse(b) # yth column
    (x - 1) * 3 + 2
  end

  defp drawing([a, b, c, d, e, f, g, h, i]) do
    """
    Noughts and crosses
    - - - - - - - -
    | #{inpsect a}, #{inpsect b}, #{inpsect v} |
    | #{inpsect d}, #{inpsect e}, #{inpsect f} |
    | #{inpsect g}, #{inpsect h}, #{inpsect i} |
    - - - - - - - -
    """
  end
end

  
